{% extends "ftc/base.html" %}

{% load static %}

{% block head %}
<!-- Include Fancytree skin and library -->
<link href="{% static 'skin-lion/ui.fancytree.min.css' %}" rel="stylesheet" type="text/css">
<script src="{% static 'jquery/jquery.fancytree.min.js' %}" type="text/javascript"></script>
<!-- Include DataTables skin and library -->
<!--
<link rel="stylesheet" type="text/css" href="{% static 'DataTables-1.10.2/media/css/jquery.dataTables.css' %}">
-->
<script type="text/javascript" charset="utf8" src="{% static 'DataTables-1.10.23/js/jquery.dataTables.min.js' %}"></script>
<!-- datatables integrate with  bootstrap-->
<link rel="stylesheet" type="text/css" href="{% static 'DataTables-1.10.23/css/dataTables.bootstrap.css' %}">
<script type="text/javascript" charset="utf8" src="{% static 'DataTables-1.10.23/js/dataTables.bootstrap.min.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'Buttons-1.6.5/css/buttons.dataTables.css' %}">
<script src="{% static 'Buttons-1.6.5/js/dataTables.buttons.js' %}" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="{% static 'Select-1.3.1/css/select.dataTables.css' %}">
<script src="{% static 'Select-1.3.1/js/dataTables.select.js' %}" type="text/javascript"></script>
<script type="text/javascript">
function updateTextInput(val) {
    document.getElementById('grain_no_txt').value=val; 
}
function showCountModal(proj, proj_id, sample, sample_id) {
    var sample_info = sample_id.split("_");
    var modal = $('#countModal');
    modal.find('.modal-body #recipient-name').val(proj);
    modal.find('.modal-body #message-text').val(sample);
    modal.find('.modal-body #grain_no').attr('placeholder','max: ' + sample_info[1]);
    modal.find('.modal-body #grain_no').attr('min', 1);
    modal.find('.modal-body #grain_no').attr('max', sample_info[1]);
    modal.find('.modal-body #proj_id').val(proj_id.substring(1))
    modal.find('.modal-body #sample_id').val(sample_info[0])
    if(sample_info[2].charAt(0).toUpperCase() == 'D') {
        modal.find('.modal-body #spontaneous').attr("disabled",true);
    }
    $('.modal-backdrop').addClass('in');
    modal.addClass('in');
}
</script>
<style type="text/css">

.label-as-badge {
    border-radius: 1em;
}

ul.fancytree-container{
	font-family:tahoma,arial,helvetica;
	font-size:10pt;
	background-color:#fff;
	border:0px none red;
        outline: none;
}

body {
  padding-top: 70px;
}
footer {
  padding: 30px 0;
}

.fa-stethoscope {
  color: white;
}

.modal.in {
    display: block;
}
.modal {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 1050;
    display: none;
    overflow: hidden;
    outline: 0;
}
.modal.fade .modal-dialog {
  transform: translate(0, -25%);
  transition: transform 0.3s ease-out;
}
.modal.in .modal-dialog {
  transform: translate(0, 0);
}
.modal-content {
  position: relative;
  background-color: #fff;
  background-clip: padding-box;
  border: 1px solid #999;
  border: 1px solid rgba(0, 0, 0, 0.2);
  border-radius: 6px;
  -webkit-box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
  box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
  outline: 0;
}
.modal-backdrop {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  z-index: 1040;
  background-color: #000;
}
.modal-backdrop.fade {
  filter: alpha(opacity=0);
  opacity: 0;
}
.modal-backdrop.in {
  filter: alpha(opacity=50);
  opacity: 0.5;
}
.modal-header {
  padding: 15px;
  border-bottom: 1px solid #e5e5e5;
}
.modal-header .close {
  margin-top: -2px;
}
.modal-title {
  margin: 0;
  line-height: 1.42857143;
}
.modal-body {
  position: relative;
  padding: 15px;
}
.modal-footer {
  padding: 15px;
  text-align: right;
  border-top: 1px solid #e5e5e5;
}
.modal-footer .btn + .btn {
  margin-bottom: 0;
  margin-left: 5px;
}
.modal-footer .btn-group .btn + .btn {
  margin-left: -1px;
}
.modal-footer .btn-block + .btn-block {
  margin-left: 0;
}
</style>

{% endblock %}
{% block left_nav_li %}{% endblock %}
{% block right_nav_li %}{% endblock %}

{% block right_nav_functon_li %}
    {% if user.is_staff %}
        <li class="divider"></li>
        <li><a href="{% url 'counting'%}"><i class="fa fa-rotate-90 fa-sliders"></i>fission track counting</a></li>
    {% endif %}
    {% if user.is_staff or user.is_superuser %}
        <li><a id='projects-link' href="{% url 'projects'%}"><i class="fa fa-flash"></i>Edit your projects</a></li>
    {% endif %}
{% endblock %}
{% block content %}
   <div class="container">

      <div class="row row-offcanvas row-offcanvas-right">
        <div class="col-xs-12 col-sm-9">
          <p class="pull-right visible-xs">
            <button type="button" class="btn-xs" data-toggle="offcanvas">Toggle nav</button>
          </p>
          <h1 class="sub-header">Results</h1>
            <table id="mytable" class="table table-striped table-bordered" cellspacing="0" width="100%">
              <thead>
                  <tr>
                      <th>Project</th>
                      <th>Sample</th>
                      <th>Grain #</th>
                      <th>Type</th>
                      <th>Result</th>
                      <th>Worker</th>
                      <th>Submit Date</th>
                  </tr>
              </thead>

              <tfoot>
                  <tr>
                      <th>Project</th>
                      <th>Sample</th>
                      <th>Grain #</th>
                      <th>Type</th>
                      <th>Result</th>
                      <th>Worker</th>
                      <th>Submit Date</th>
                  </tr>
              </tfoot>
            </table>

      </div>

                    <!--
                    <div style="cursor: default;"> {{ sample.sample_name }}&nbsp;
                    <a href="{{ project.id }}/{{ sample.id }}/{{ sample.total_grains }}"><i class="fa fa-stethoscope"></i></a></div>
                    -->

       <div class="col-xs-6 col-sm-3 sidebar-offcanvas" id="sidebar" role="navigation">
          <div>
            <h1 class="sub-header bg-primary">Projects</h1>
          </div>
          <h5 class="text-muted"><small>Check to view the results or Select to count a grain:</small></h5>
          <div id="tree">
            <ul>
             {% for project in projects.all %}
             <li id="p{{ project.id }}" class="folder">{{ project.project_name }}
                <ul>
                {% for sample in project.sample_set.all %}
                  <li id="{{ sample.id }}_{{ sample.total_grains }}_{{ sample.sample_property }}">{{ sample.sample_name }}</li>
                {% endfor %}
                </ul>
             </li>
             {% endfor %}
            </ul>
          </div>
        </div>

        <div class="modal fade" id="countModal" tabindex="-1" role="dialog" aria-labelledby="countModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-sm">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="countModalLabel">Choose a grain for FTC</h4>
              </div>
              <div class="modal-body">
              <div class="container-fluid">
                <form id="request-grain">
                  <div class="form-group">
                    <label for="recipient-name" class="control-label">Project:</label>
                    <input type="text" class="form-control" id="recipient-name" readonly>
                  </div>
                  <div class="form-group">
                    <label for="message-text" class="control-label">Sample:</label>
                    <input type="text" class="form-control" id="message-text" readonly>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <label for="message-text" class="control-label">Grain No.:</label>
                      <input type="text" class="form-control" id="grain_no_txt" value="1" readonly>
                      <input type="range" name="grain_num" id="grain_no" value="1" step="1" oninput="updateTextInput(this.value);">
                    </div>
                    <div class="col-md-6">
                      <label for="message-text" class="control-label">Type:</label>
                      <div class="radio"><label><input type="radio" name="ft_type" id='induced' value="I">Induced</label></div>
                      <div class="radio"><label><input type="radio" name="ft_type" id='spontaneous' value="S" checked>Spontaneous</label></div>
                    </div>
                  </div>
                  <div>
                    <div class="form-group">
                      <input type="hidden" name="proj_id" id="proj_id" value="">
                      <input type="hidden" name="sample_id" id="sample_id" value="">
                    </div>
                  </div>
                </form>
              </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn" data-dismiss="modal" onclick="dropModal()">Close</button>
                <button type="submit" class="btn btn-primary" id="count_grain">Start</button>
              </div>
            </div>
          </div>
        </div>

    </div> <!-- /container -->

<script type="text/javascript">
  $(function(){

  $('[data-toggle="offcanvas"]').click(function () {
    $('.row-offcanvas').toggleClass('active')
  });

    // https://coderwall.com/p/cxwg_g
    // pass csrf tokens to Django
    $.ajaxSetup({beforeSend: function(xhr, settings){

        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');

    }});

    var dataTable; //reference to your dataTable
    dataTable = $('#mytable').dataTable({
                    "jQueryUI": true,
                    "dom": 'T<"clear">lfrtip',
                    "tableTools": {
                          "sSwfPath": "{% static 'DataTables-1.10.2/extensions/TableTools/swf/copy_csv_xls_pdf.swf' %}"
                    },
/*
                    "columns": [
                       { "width": "15%" },
                       { "width": "15%" },
                       { "width": "5%" },
                       { "width": "2%" },
                       { "width": "5%" },
                       { "width": "15%" },
                       { "width": "15%" },
                    ]
*/
                });
    //new $.fn.dataTable.FixedHeader( dataTable );

    // Create the tree inside the <div id="tree"> element.
    $("#tree").fancytree({
     /* extensions: ["childcounter"],
        childcounter: {
            deep: true,
            hideZeros: true,
            hideExpanded: true,
        }, */
        checkbox: true,
        persist: true,
        selectMode: 3, // 1:single, 2:multi, 3:multi-hier
        renderNode: function (event, data) {
           var node = data.node;
           leaf_node = $(node.span).not('.fancytree-has-children')
           if((leaf_node.length != 0) && !(leaf_node.children().hasClass('label-as-badge')) ) {
               var btn_html = '<span class="label label-primary btn btn-xs">count</span>';
               var countButton = $(btn_html); 
               countButton.bind('click', function() {
                showCountModal(node.parent.title, node.parent.key, node.title, node.key);
               });
               countButton.css('cursor','pointer');
               leaf_node.append(countButton);
               countButton.hide();
               leaf_node.hover(function () {
                  // mouse over
                  countButton.show();
                  }, function () {
                  // mouse out
                  countButton.hide();
               });
           } // end lead_node setting
        },
        select: function(event, data) {
            // Get a list of all selected nodes
            var selectedNodes = data.tree.getSelectedNodes();
            // ... and convert to a key array:
            var selectedKeys = $.map(selectedNodes, function(node){
               return (node.key.charAt(0).toLowerCase() == 'p') ? null : node.key.split('_')[0];
            });
            $.ajax({
                url: "{% url 'getTableData'%}",
                type: 'POST',
                //contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                data: JSON.stringify({
                         client_response: selectedKeys,
                         //csrfmiddlewaretoken: '{{ csrf_token }}' 
                      }),
                success: function(result) {
                             //console.log(dataTable);
                             //console.log(result);
                             if (result.aaData.length > 0) {
                                 dataTable.fnClearTable();
                                 dataTable.fnAddData(result.aaData);
                                 dataTable.fnDraw();
                                 //dataTable.columns.adjust().draw();
                             } else {
                                 dataTable.fnClearTable();
                                 dataTable.fnDraw();
                             }
                         },
                error : function(xhr,errmsg,err) {
                             console.log(xhr.status + ": " + xhr.responseText);
                        },
            });
            // ... update table data
            // dataTable.ajax.url( '/getTableData/' ).load();
        },
    }); // end of tree

    //
    $('button#count_grain').click(function(event) {
        var o = {};
        var a = $('form#request-grain').serializeArray();
        a.push({name:'num_markers', 'value':'0'});
        a.push({name:'marker_latlngs', 'value':[]});
        $.each(a, function() {
            if(this.name != 'ft_type' && this.name != 'marker_latlngs') {
                value = parseInt(this.value);
            } else {
                value = this.value; 
            }
            if (o[this.name] !== undefined) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(value);
            } else {
                o[this.name] = value;
            }
        });
        $.ajax({
            url: "{% url 'saveWorkingGrain'%}",
            type: 'POST',
            dataType: 'json',
            data: JSON.stringify({'intermedia_res':o}),
            success: function(result) {
                console.log('submitted: ' + result.reply);
                window.location = "{% url 'counting'%}";
            },
            error: function(xhr, errmsg, err) {
                console.log(xhr.status + ": " + xhr.responseText);
                alert('Failed to save your intermedia result, Please try again.');
            }
        });
        event.preventDefault();
    }); 
    // end submit
  });
</script>

{% endblock %}

</body>
</html>
